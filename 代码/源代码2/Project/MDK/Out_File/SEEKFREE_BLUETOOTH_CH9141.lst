C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE SEEKFREE_BLUETOOTH_CH9141
OBJECT MODULE PLACED IN .\Out_File\SEEKFREE_BLUETOOTH_CH9141.obj
COMPILER INVOKED BY: D:\Keil_v5\C251\BIN\C251.EXE ..\..\Libraries\seekfree_peripheral\SEEKFREE_BLUETOOTH_CH9141.c XSMALL
                    - INTR2 WARNINGLEVEL(0) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfr
                    -ee_peripheral;..\CODE;..\USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\SEEKFREE_BLUETOOTH_CH9141.lst) TABS(2) OBJECT(.\Ou
                    -t_File\SEEKFREE_BLUETOOTH_CH9141.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2021,é€é£ç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
    9           *
   10           * @file          é€é£ç§‘æŠ€è“ç‰™è½¬ä¸²å£æ¨¡å—
   11           * @company       æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author        é€é£ç§‘æŠ€(QQ3184284598)
   13           * @version       æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   14           * @Software    IAR 8.3 or MDK 5.33
   15           * @Taobao      https://seekfree.taobao.com/
   16           * @date          2021-08-27
   17           * @note
   18                              æ¥çº¿å®šä¹‰ï¼š
   19                              ------------------------------------
   20                                  è“ç‰™è½¬ä¸²å£      å•ç‰‡æœº
   21                                  RX              æŸ¥çœ‹SEEKFREE_BLUETOOTH_CH9141.hæ–‡ä»¶ä¸­çš„BLUETOOTH_CH9141_UAR
             -T_TXå®å®šä¹‰
   22                                  TX              æŸ¥çœ‹SEEKFREE_BLUETOOTH_CH9141.hæ–‡ä»¶ä¸­çš„BLUETOOTH_CH9141_UAR
             -T_RXå®å®šä¹‰
   23                                  RTS             æŸ¥çœ‹SEEKFREE_BLUETOOTH_CH9141.hæ–‡ä»¶ä¸­çš„BLUETOOTH_CH9141_RTS
             -_PINå®å®šä¹‰
   24                                  CTS             æ‚¬ç©º
   25                                  CMD             æ‚¬ç©ºæˆ–è€…ä¸Šæ‹‰
   26                              ------------------------------------
   27           ********************************************************************************************************
             -************/
   28          #include "stdio.h"
   29          #include "string.h"
   30          #include "board.h"
   31          #include "zf_gpio.h"
   32          #include "zf_uart.h"
   33          #include "zf_nvic.h"
   34          #include "zf_delay.h"
   35          #include "headfile.h"
   36          #include "SEEKFREE_BLUETOOTH_CH9141.h"
   37          
   38          uint8 uart_data;
   39          uint8 uart_flag;
   40          
   41          vuint8 at_mode = 0;      // 0:è“ç‰™é€ä¼ æ¨¡å¼ 1:ATæ¨¡å¼ 2:æ¨¡å—å¤ä½ä¸­
   42          vuint8 at_mode_num;      // atæ¨¡å¼æ—¶ç”¨äºæŒ‡ç¤ºæ•°æ®æ¥æ”¶çš„æ•°é‡
   43          vuint8 at_mode_data[30]; //æ¥æ”¶atå‘½ä»¤çš„ç¼“å­˜
   44          vuint8 at_mode_cmd_flag; // OKåº”ç­”å‘½ä»¤æ¥æ”¶æˆåŠŸçš„æ ‡å¿—ä½
   45          
   46          uint8 mac_address[17]; //æœ¬æœºmacåœ°å€
   47          
   48          uint8 bluetooth_ch9141_rx_buffer;
   49          
   50          void bluetooth_ch9141_check_response(void);
   51          
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 2   

   52          //-------------------------------------------------------------------------------------------------------
             -------------
   53          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å— ä¸²å£ä¸­æ–­å›è°ƒå‡½æ•°
   54          //  @param      NULL
   55          //  @return     void
   56          //  @since      v1.0
   57          //  Sample usage:
   58          //  @note       è¯¥å‡½æ•°åœ¨ISRæ–‡ä»¶ ä¸²å£8ä¸­æ–­ç¨‹åºè¢«è°ƒç”¨
   59          //-------------------------------------------------------------------------------------------------------
             -------------
   60          void bluetooth_ch9141_uart_callback(void)
   61          {
   62   1          if (1 == at_mode)
   63   1          {
   64   2              //è¿›å…¥ATæ¨¡å¼ æ¥æ”¶åº”ç­”ä¿¡å· æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   65   2              //æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   66   2              at_mode_data[at_mode_num++] = BLUETOOTH_CH9141_DATA_BUF;
   67   2              bluetooth_ch9141_check_response();
   68   2          }
   69   1          else if (2 == at_mode)
   70   1          {
   71   2              //æ¨¡å—æ­£åœ¨å¤ä½ä¸­ æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   72   2              //æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   73   2              at_mode_num++;
   74   2          }
   75   1          else
   76   1          {
   77   2              //é€ä¼ æ¨¡å¼ ç”¨æˆ·åœ¨æ­¤å¤„æ¥æ”¶é…å¯¹çš„è“ç‰™å‘é€è¿‡æ¥çš„é¢æ•°æ®
   78   2              //æ¥åˆ°ä¸€ä¸ªå­—èŠ‚åå•ç‰‡æœºå°†ä¼šè¿›å…¥æ­¤å¤„ï¼Œé€šè¿‡åœ¨æ­¤å¤„è¯»å–bluetooth_ch9141_rx_buf
             -ferå¯ä»¥å–èµ°æ•°æ®
   79   2              uart_data = BLUETOOTH_CH9141_DATA_BUF;
   80   2              beep(3);
   81   2          }
   82   1      }
   83          
   84          //-------------------------------------------------------------------------------------------------------
             -------------
   85          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—æ£€æŸ¥OKåº”ç­”ä¿¡å·
   86          //  @param      NULL
   87          //  @return     void
   88          //  @since      v1.0
   89          //  Sample usage:
   90          //  @note       ç”¨æˆ·æ— éœ€å…³å¿ƒ
   91          //-------------------------------------------------------------------------------------------------------
             -------------
   92          void bluetooth_ch9141_check_response(void)
   93          {
   94   1          if (4 <= at_mode_num)
   95   1          {
   96   2              if (0 == strncmp("OK\r\n", (int8 *)&at_mode_data[at_mode_num - 4], 4))
   97   2              {
   98   3                  at_mode_cmd_flag = 1;
   99   3              }
  100   2          }
  101   1      }
  102          
  103          //-------------------------------------------------------------------------------------------------------
             -------------
  104          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å‘é€ä¸€ä¸ªæ²¡æœ‰å‚æ•°çš„å‘½ä»¤å¹¶ç­‰å¾…åº”ç­”ä¿¡å·
  105          //  @param      *str    éœ€è¦å‘é€çš„å‘½ä»¤ å®Œæ•´å­—ç¬¦ä¸²
  106          //  @return     void
  107          //  @since      v1.0
  108          //  Sample usage:
  109          //  @note       ç”¨æˆ·æ— éœ€å…³å¿ƒ
  110          //-------------------------------------------------------------------------------------------------------
             -------------
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 3   

  111          void bluetooth_ch9141_send_at_command(const int8 *str)
  112          {
  113   1          at_mode_num = 0; //æ¥æ”¶æ•°é‡æ¸…é›¶
  114   1          uart_putstr(BLUETOOTH_CH9141_UART, str);
  115   1          uart_putstr(BLUETOOTH_CH9141_UART, "\r\n");
  116   1      
  117   1          //ç­‰å¾…æ”¶åˆ°åº”ç­”ä¿¡å·
  118   1          while (!at_mode_cmd_flag)
  119   1              ;
  120   1          at_mode_cmd_flag = 0;
  121   1      }
  122          
  123          //-------------------------------------------------------------------------------------------------------
             -------------
  124          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å‘é€ä¸€ä¸ªå¸¦æœ‰å‚æ•°çš„å‘½ä»¤å¹¶ç­‰å¾…åº”ç­”ä¿¡å·
  125          //  @param      *cmd    éœ€è¦å‘é€çš„å‘½ä»¤åç§°
  126          //  @param      *dat   éœ€è¦å‘é€çš„æ•°æ®
  127          //  @return     void
  128          //  @since      v1.0
  129          //  Sample usage:
  130          //  @note       ç”¨æˆ·æ— éœ€å…³å¿ƒ
  131          //-------------------------------------------------------------------------------------------------------
             -------------
  132          void bluetooth_ch9141_send_at_command_parameter(const int8 *cmd, const int8 *dat)
  133          {
  134   1          at_mode_num = 0; //æ¥æ”¶æ•°é‡æ¸…é›¶
  135   1          uart_putstr(BLUETOOTH_CH9141_UART, "AT+");
  136   1          uart_putstr(BLUETOOTH_CH9141_UART, cmd);
  137   1          uart_putstr(BLUETOOTH_CH9141_UART, "=");
  138   1          uart_putstr(BLUETOOTH_CH9141_UART, dat);
  139   1          uart_putstr(BLUETOOTH_CH9141_UART, "\r\n");
  140   1      
  141   1          //ç­‰å¾…æ”¶åˆ°åº”ç­”ä¿¡å·
  142   1          while (!at_mode_cmd_flag)
  143   1              ;
  144   1          at_mode_cmd_flag = 0;
  145   1      }
  146          
  147          //-------------------------------------------------------------------------------------------------------
             -------------
  148          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è¿›å…¥ATæ¨¡å¼
  149          //  @param      NULL
  150          //  @return     void
  151          //  @since      v1.0
  152          //  Sample usage:
  153          //  @note
  154          //-------------------------------------------------------------------------------------------------------
             -------------
  155          void bluetooth_ch9141_enter_at_mode(void)
  156          {
  157   1          delay_ms(600); //å‘é€è¿›å…¥ATæ¨¡å¼çš„å‘½ä»¤å‰éœ€è¦ä¿è¯æ¨¡å—åœ¨550mså†…æ²¡æœ‰æ¥æ”¶è¿‡ä»»ä½•æ•
             -°æ®
  158   1          at_mode = 1;   //è¿›å…¥ATæ¨¡å¼
  159   1          bluetooth_ch9141_send_at_command("AT...");
  160   1      }
  161          
  162          //-------------------------------------------------------------------------------------------------------
             -------------
  163          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—é€€å‡ºATæ¨¡å¼
  164          //  @param      NULL
  165          //  @return     void
  166          //  @since      v1.0
  167          //  Sample usage:
  168          //  @note
  169          //-------------------------------------------------------------------------------------------------------
             -------------
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 4   

  170          void bluetooth_ch9141_exit_at_mode(void)
  171          {
  172   1          bluetooth_ch9141_send_at_command("AT+EXIT");
  173   1          at_mode = 0;   //è¿›å…¥é€ä¼ æ¨¡å¼
  174   1          delay_ms(300); //ç­‰å¾…æˆåŠŸè¿›å…¥ATæ¨¡å¼
  175   1      }
  176          
  177          //-------------------------------------------------------------------------------------------------------
             -------------
  178          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å¤ä½
  179          //  @param      NULL
  180          //  @return     void
  181          //  @since      v1.0
  182          //  Sample usage:
  183          //  @note
  184          //-------------------------------------------------------------------------------------------------------
             -------------
  185          void bluetooth_ch9141_reset(void)
  186          {
  187   1          bluetooth_ch9141_send_at_command("AT+RESET");
  188   1          at_mode = 2; //è¿›å…¥é‡å¯æˆåŠŸæ£€æµ‹
  189   1          at_mode_num = 0;
  190   1          while (7 > at_mode_num)
  191   1              ;        //ç­‰å¾…è“ç‰™æ¨¡å—å®Œæˆå¤ä½
  192   1          at_mode = 0; //å¤ä½ä¹‹åæ¨¡å—è‡ªåŠ¨è¿›å…¥é€ä¼ æ¨¡å¼
  193   1      }
  194          
  195          //-------------------------------------------------------------------------------------------------------
             -------------
  196          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è·å–æœ¬æœºMACåœ°å€
  197          //  @param      NULL
  198          //  @return     void
  199          //  @since      v1.0
  200          //  Sample usage:
  201          //  @note       è°ƒç”¨æ­¤å‡½æ•°éœ€è¦å…ˆè°ƒç”¨bluetooth_ch9141_enter_at_modeæˆ–è€…æ‹‰ä½CMDå¼•è„š è¿›å…¥A
             -Tæ¨¡å¼
  202          //              éœ€è¦ç‰¹åˆ«æ³¨æ„bluetooth_ch9141_enter_at_modeå‡½æ•°å†…éƒ¨æœ‰500msçš„å»¶æ—¶
  203          //-------------------------------------------------------------------------------------------------------
             -------------
  204          void bluetooth_ch9141_get_mac_address(void)
  205          {
  206   1          bluetooth_ch9141_send_at_command("AT+MAC?");
  207   1      
  208   1          // macåœ°å€ä¸ºå°æ®µæ ¼å¼ï¼Œmac_address[0]ä¿å­˜çš„æ˜¯macåœ°å€æœ€ä½ä½
  209   1          memcpy(mac_address, (uint8 *)at_mode_data, 17);
  210   1      }
  211          
  212          //-------------------------------------------------------------------------------------------------------
             -------------
  213          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è®¾ç½®å‘é€åŠŸç‡
  214          //  @param      tx_power    è®¾ç½®å‘é€åŠŸç‡ï¼Œå¯è®¾ç½®é€‰é¡¹æŸ¥çœ‹CH9141_TX_POWEER_enumæšä¸¾æˆå‘˜
  215          //  @return     void
  216          //  @since      v1.0
  217          //  Sample usage:
  218          //  @note
  219          //-------------------------------------------------------------------------------------------------------
             -------------
  220          void bluetooth_ch9141_set_tx_power(CH9141_TX_POWEER_enum tx_power)
  221          {
  222   1          int8 tx_power_data;
  223   1      
  224   1          tx_power_data = (uint8)tx_power + '0';
  225   1          bluetooth_ch9141_send_at_command_parameter("TPL", &tx_power_data);
  226   1      }
  227          
  228          //-------------------------------------------------------------------------------------------------------
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 5   

             -------------
  229          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è®¾ç½®æ¨¡å¼
  230          //  @param      mode    æ¨¡å¼è®¾ç½®ï¼Œå¯è®¾ç½®é€‰é¡¹æŸ¥çœ‹CH9141_MODE_enumæšä¸¾æˆå‘˜
  231          //  @return     void
  232          //  @since      v1.0
  233          //  Sample usage:
  234          //  @note
  235          //-------------------------------------------------------------------------------------------------------
             -------------
  236          void bluetooth_ch9141_set_mode(CH9141_MODE_enum mode)
  237          {
  238   1          int8 mode_data;
  239   1      
  240   1          mode_data = (uint8)mode + '0';
  241   1          bluetooth_ch9141_send_at_command_parameter("BLEMODE", &mode_data);
  242   1      }
  243          
  244          //-------------------------------------------------------------------------------------------------------
             -------------
  245          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è·å–çŠ¶æ€
  246          //  @param      mode    æ¨¡å¼è®¾ç½®ï¼Œå¯è®¾ç½®é€‰é¡¹æŸ¥çœ‹CH9141_MODE_enumæšä¸¾æˆå‘˜
  247          //  @return     CH9141_STATUS_enum  è¿”å›çŠ¶æ€ä¿¡æ¯
  248          //  @since      v1.0
  249          //  Sample usage:
  250          //  @note
  251          //-------------------------------------------------------------------------------------------------------
             -------------
  252          CH9141_STATUS_enum bluetooth_ch9141_get_status(CH9141_MODE_enum mode)
  253          {
  254   1          CH9141_STATUS_enum ch9141_status;
  255   1          int8 mode_data;
  256   1      
  257   1          mode_data = (uint8)mode + '0';
  258   1          bluetooth_ch9141_send_at_command_parameter("BLEMODE", &mode_data);
  259   1      
  260   1          bluetooth_ch9141_send_at_command("AT+BLESTA?");
  261   1      
  262   1          ch9141_status = (at_mode_data[0] - '0') * 10 + (at_mode_data[1] - '0');
  263   1          if (SLAVE_MODE == mode)
  264   1          {
  265   2              ch9141_status += SLAVE_NO_INIT;
  266   2          }
  267   1      
  268   1          return ch9141_status;
  269   1      }
  270          
  271          //-------------------------------------------------------------------------------------------------------
             -------------
  272          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è®¾ç½®è®¾å¤‡åç§°
  273          //  @param      *str    è“ç‰™åç§°
  274          //  @return     void
  275          //  @since      v1.0
  276          //  Sample usage:
  277          //  @note       åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡18ä¸ªå­—ç¬¦ ä¸”åªèƒ½ä¸ºè‹±æ–‡ä¸æ•°å­—
  278          //-------------------------------------------------------------------------------------------------------
             -------------
  279          void bluetooth_ch9141_set_name(const int8 *str)
  280          {
  281   1          bluetooth_ch9141_send_at_command_parameter("NAME", str);
  282   1          bluetooth_ch9141_send_at_command_parameter("PNAME", str);
  283   1      }
  284          
  285          //-------------------------------------------------------------------------------------------------------
             -------------
  286          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å¯†ç è®¾ç½®
  287          //  @param      enable      ä½¿èƒ½å¯†ç  0ï¼šä¸ä½¿ç”¨å¯†ç ï¼Œ1ï¼šä½¿ç”¨å¯†ç æ‰èƒ½è¿æ¥æœ¬è®¾å¤‡
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 6   

  288          //  @param      *password   å¯†ç çš„å­—ç¬¦ä¸² å¿…é¡»ä¸º6ä¸ªå­—ç¬¦
  289          //  @return     void
  290          //  @since      v1.0
  291          //  Sample usage:
  292          //  @note
  293          //-------------------------------------------------------------------------------------------------------
             -------------
  294          void bluetooth_ch9141_set_password(uint8 enable, const int8 *password)
  295          {
  296   1          if (0 == enable)
  297   1          {
  298   2              //å…³é—­å¯†ç 
  299   2              bluetooth_ch9141_send_at_command_parameter("PASEN", "OFF");
  300   2          }
  301   1          else
  302   1          {
  303   2              //è®¾ç½®å¯†ç å¹¶ä½¿èƒ½
  304   2              bluetooth_ch9141_send_at_command_parameter("PASEN", "ON");
  305   2              bluetooth_ch9141_send_at_command_parameter("PASS", password);
  306   2          }
  307   1      }
  308          
  309          //-------------------------------------------------------------------------------------------------------
             -------------
  310          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—æŒ‡å®šMACåœ°å€å¹¶ç«‹å³è¿›è¡Œè¿æ¥
  311          //  @param      *mac_and_password      éœ€è¦è¿æ¥çš„è®¾å¤‡macåœ°å€ä¸å¯†ç 
  312          //  @return     void
  313          //  @since      v1.0
  314          //  Sample usage:
  315          //  @note       bluetooth_ch9141_connect("58:B7:33:E4:C2:84,000000");
  316          //              58:B7:33:E4:C2:84ä¸ºmacåœ°å€ ,ä¸ºåˆ†éš”ç¬¦ 000000ä¸ºä»æœºè“ç‰™å¯†ç 
  317          //              ===================ç‰¹åˆ«æ³¨æ„==================
  318          //              å¦‚æœä½¿ç”¨æ‰‹æœºæŸ¥çœ‹è“ç‰™çš„macåœ°å€ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™è¯·å°†macå€
             -’ç½®ä¸€ä¸‹
  319          //              ä¾‹å¦‚æ‰‹æœºæŸ¥çœ‹åˆ°çš„macåœ°å€ä¸º61:62:63:64:65:66ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™
             -åº”è¯¥å†™
  320          //              bluetooth_ch9141_connect("66:65:64:63:62:61,000000");
  321          //-------------------------------------------------------------------------------------------------------
             -------------
  322          void bluetooth_ch9141_connect(const int8 *mac_and_password)
  323          {
  324   1          bluetooth_ch9141_send_at_command_parameter("CONN", mac_and_password);
  325   1      }
  326          
  327          //-------------------------------------------------------------------------------------------------------
             -------------
  328          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—é»˜è®¤è¿æ¥å‚æ•°è®¾ç½®ï¼ˆè®¾ç½®å¥½åï¼Œæ¯æ¬¡å¼€æœºè“ç‰™ä¼šè‡ªåŠ
             -¨é“¾æ¥è¿™ä¸ªè®¾å¤‡ï¼‰
  329          //  @param      *mac_and_password      éœ€è¦è¿æ¥çš„è®¾å¤‡macåœ°å€ä¸å¯†ç 
  330          //  @return     void
  331          //  @since      v1.0
  332          //  Sample usage:
  333          //  @note       bluetooth_ch9141_default_connect("58:B7:33:E4:C2:84,000000");
  334          //              58:B7:33:E4:C2:84ä¸ºmacåœ°å€ ,ä¸ºåˆ†éš”ç¬¦ 000000ä¸ºä»æœºè“ç‰™å¯†ç 
  335          //              ===================ç‰¹åˆ«æ³¨æ„==================
  336          //              å¦‚æœä½¿ç”¨æ‰‹æœºæŸ¥çœ‹CH9141çš„macåœ°å€ï¼Œå°†CH9141è®¾ç½®ä¸ºä»æœºï¼Œä½¿ç”¨æ‰‹æœºè¿æ
             -¥
  337          //              åˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™è¯·å°†macå€’ç½®ä¸€ä¸‹
  338          //              ä¾‹å¦‚æ‰‹æœºæŸ¥çœ‹åˆ°çš„macåœ°å€ä¸º61:62:63:64:65:67ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™
             -åº”è¯¥å†™
  339          //              bluetooth_ch9141_default_connect("67:65:64:63:62:61,000000");
  340          //-------------------------------------------------------------------------------------------------------
             -------------
  341          void bluetooth_ch9141_default_connect(const int8 *mac_and_password)
  342          {
  343   1          bluetooth_ch9141_send_at_command_parameter("CONADD", mac_and_password);
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 7   

  344   1      }
  345          
  346          //-------------------------------------------------------------------------------------------------------
             -------------
  347          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è·å–rssi(ä¿¡å·å¼ºåº¦)
  348          //  @param      void
  349          //  @return     int8    è¿”å›ä¿¡å·å¼ºåº¦0åˆ°-127
  350          //  @since      v1.0
  351          //  Sample usage:
  352          //  @note       è°ƒç”¨æ­¤å‡½æ•°éœ€è¦å…ˆè°ƒç”¨bluetooth_ch9141_enter_at_modeæˆ–è€…æ‹‰ä½CMDå¼•è„š è¿›å…¥A
             -Tæ¨¡å¼
  353          //              éœ€è¦ç‰¹åˆ«æ³¨æ„bluetooth_ch9141_enter_at_modeå‡½æ•°å†…éƒ¨æœ‰500msçš„å»¶æ—¶
  354          //-------------------------------------------------------------------------------------------------------
             -------------
  355          int16 bluetooth_ch9141_get_rssi(void)
  356          {
  357   1          uint8 i;
  358   1          size_t length;
  359   1          int16 rssi;
  360   1          bluetooth_ch9141_send_at_command_parameter("RSSI", "ON,0");
  361   1          length = strlen((int8 *)at_mode_data);
  362   1          length -= 12; //è®¡ç®—RSSI æœ‰å¤šå°‘ä½
  363   1      
  364   1          rssi = 0;
  365   1          for (i = 0; i < length; i++)
  366   1          {
  367   2              rssi = rssi * 10 + (at_mode_data[0] - '0');
  368   2          }
  369   1      
  370   1          return -rssi;
  371   1      }
  372          
  373          //-------------------------------------------------------------------------------------------------------
             -------------
  374          //  @brief      æ— çº¿è½¬ä¸²å£æ¨¡å— å‘é€å‡½æ•°
  375          //  @param      buff        éœ€è¦å‘é€çš„æ•°æ®åœ°å€
  376          //  @param      len         å‘é€é•¿åº¦
  377          //  @return     uint32      å‰©ä½™æœªå‘é€çš„å­—èŠ‚æ•°
  378          //  @since      v1.0
  379          //  Sample usage:
  380          //  @note
  381          //-------------------------------------------------------------------------------------------------------
             -------------
  382          uint32 bluetooth_ch9141_send_buff(uint8 *buff, uint32 len)
  383          {
  384   1          while (len)
  385   1          {
  386   2              //æµæ§æ£€æŸ¥ RTSä¸ºé«˜è¡¨ç¤ºè“ç‰™æ¨¡å—å†…éƒ¨ç¼“å†²å·²æ»¡æ— æ³•ç»§ç»­æ¥æ”¶æ•°æ®
  387   2      
  388   2              // RTSä¸ºé«˜å¤„ç†æ–¹å¼ä¸€ï¼šå¦‚æœæ£€æµ‹åˆ°RTSä¸ºé«˜åˆ™åé¢çš„æ•°æ®ä¸å†ç»§ç»­å‘é€ï¼Œé¿å
             -…å‡ºç°ç­‰å¾…
  389   2              if (BLUETOOTH_CH9141_RTS_PIN)
  390   2              {
  391   3                  break;
  392   3              }
  393   2      
  394   2              // RTSä¸ºé«˜å¤„ç†æ–¹å¼äºŒï¼šå¦‚æœæ£€æµ‹åˆ°RTSä¸ºé«˜åˆ™ç­‰å¾…RTSä¸ºä½ä¹‹åç»§ç»­å‘é€æ•°æ®
  395   2              // while(gpio_get(BLUETOOTH_CH9141_RTS_PIN));  //å¦‚æœRTSä¸ºä½ç”µå¹³ï¼Œåˆ™ç»§ç»­å‘é€æ•°æ®
  396   2      
  397   2              //å‘é€æ•°æ®
  398   2              uart_putchar(BLUETOOTH_CH9141_UART, *buff);
  399   2      
  400   2              buff++;
  401   2              len--;
  402   2          }
  403   1      
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 8   

  404   1          return len;
  405   1      }
  406          
  407          //-------------------------------------------------------------------------------------------------------
             -------------
  408          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—åˆå§‹åŒ–
  409          //  @param      mode    è“ç‰™æ¨¡å¼ MASTER_MODE(ä¸»æœº)æˆ–è€…SLAVE_MODE(ä»æœº)
  410          //  @return     void
  411          //  @since      v1.0
  412          //  Sample usage:
  413          //  @note
  414          //-------------------------------------------------------------------------------------------------------
             -------------
  415          void bluetooth_ch9141_init(CH9141_MODE_enum mode, int8 *salve_mac_password)
  416          {
  417   1      
  418   1          //===================ç‰¹åˆ«æ³¨æ„==================
  419   1          //å¦‚æœä½¿ç”¨æ‰‹æœºæŸ¥çœ‹è“ç‰™çš„macåœ°å€ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™è¯·å°†macå€’ç½®ä¸€ä¸‹
  420   1          //ä¾‹å¦‚æ‰‹æœºæŸ¥çœ‹åˆ°çš„macåœ°å€ä¸º61:62:63:64:65:66ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™åº”è¯¥å†™
  421   1          // bluetooth_ch9141_connect("66:65:64:63:62:61,000000");
  422   1          // 58:B7:33:E4:C2:84ä¸ºmacåœ°å€ ,ä¸ºåˆ†éš”ç¬¦ 000000ä¸ºä»æœºè“ç‰™å¯†ç 
  423   1          //ä»æœºMACåœ°å€ä¸å¯†ç 
  424   1      
  425   1          //æœ¬å‡½æ•°ä½¿ç”¨çš„æ³¢ç‰¹ç‡ä¸º115200ï¼Œä¸ºè“ç‰™è½¬ä¸²å£æ¨¡å—çš„é»˜è®¤æ³¢ç‰¹ç‡ï¼Œå¦‚éœ€å…¶ä»–æ³¢
             -ç‰¹ç‡è¯·ä½¿ç”¨ä¸Šä½æœºä¿®æ”¹æ¨¡å—å‚æ•°
  426   1          //åˆå§‹åŒ–æµæ§å¼•è„š
  427   1          wireless_type = WIRELESS_CH9141;
  428   1          //å¦‚æœä¸æ¥RTSå¼•è„šï¼Œåˆ™RTSå¼•è„šé»˜è®¤ä¸ºé«˜ç”µå¹³ï¼Œè¿™é‡Œéœ€è¦å°†å…¶è®¾ç½®ä¸ºä½ç”µå¹³ã€‚
  429   1          BLUETOOTH_CH9141_RTS_PIN = 0;
  430   1          //åˆå§‹åŒ–ä¸²å£
  431   1          uart_init(BLUETOOTH_CH9141_UART, BLUETOOTH_CH9141_UART_RX, BLUETOOTH_CH9141_UART_TX, BLUETOOTH_CH9141
             -_UART_BAUD, BLUETOOTH_CH9141_TIMER_N); //åˆå§‹æ¢ä¸²å£
  432   1      
  433   1          EnableGlobalIRQ();
  434   1      
  435   1          //è“ç‰™åˆ†ä¸ºä¸»æœºä¸ä»æœºæ¨¡å¼ï¼Œä¸¤ä¸ªè“ç‰™æƒ³è¦è¿æ¥æˆåŠŸå°±å¿…é¡»æœ‰ä¸€ä¸ªä¸ºä¸»æœºï¼Œæœ‰
             -ä¸€ä¸ªä¸ºä»æœºï¼Œæ‰€ä»¥è°ƒç”¨åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦åˆç†çš„å¡«å†™å‡½æ•°å‚æ•°æ‰èƒ½æˆåŠŸçš„è¿æ¥
  436   1          //è“ç‰™åˆ†ä¸ºä¸»æœºä¸ä»æœºæ¨¡å¼ï¼Œä¸¤ä¸ªè“ç‰™æƒ³è¦è¿æ¥æˆåŠŸå°±å¿…é¡»æœ‰ä¸€ä¸ªä¸ºä¸»æœºï¼Œæœ‰
             -ä¸€ä¸ªä¸ºä»æœºï¼Œæ‰€ä»¥è°ƒç”¨åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦åˆç†çš„å¡«å†™å‡½æ•°å‚æ•°æ‰èƒ½æˆåŠŸçš„è¿æ¥
  437   1          //ä¸Šç”µé¡ºåºï¼šæœ€å¥½ä»æœºå…ˆä¸Šç”µï¼Œç„¶åä¸»æœºå†ä¸Šç”µ
  438   1      
  439   1          if (MASTER_MODE == mode)
  440   1          {
  441   2              // 1.å°†è“ç‰™è®¾ç½®ä¸ºä¸»æœºæ¨¡å¼ï¼Œç„¶åè¿æ¥æŒ‡å®šmacåœ°å€çš„ä»æœºè®¾å¤‡
  442   2      
  443   2              bluetooth_ch9141_enter_at_mode();   //è¿›å…¥ATæ¨¡å¼
  444   2              bluetooth_ch9141_set_mode(mode);    //è®¾ç½®è“ç‰™æ¨¡å¼
  445   2              bluetooth_ch9141_get_mac_address(); //è·å–æœ¬æœºMACåœ°å€
  446   2              bluetooth_ch9141_reset();           //è®¾ç½®å®Œæˆåéœ€è¦å¤ä½ï¼Œè®¾ç½®æ‰ä¼šç”Ÿæ•ˆ
  447   2              bluetooth_ch9141_enter_at_mode();   //è¿›å…¥ATæ¨¡å¼
  448   2      
  449   2              //è®¾ç½®å®Œæ¨¡å¼ä¹‹åéœ€è¦å¤ä½ç„¶åå†æ¬¡è¿›å…¥ATæ¨¡å¼æ‰èƒ½ç»§ç»­è®¾ç½®å…¶ä»–å‚æ•°ï¼Œå¦
             -åˆ™æ¨¡å¼è®¾ç½®ä¸æˆåŠŸ
  450   2              bluetooth_ch9141_set_tx_power(TX_POWER_4DB); //è®¾ç½®è“ç‰™å‘é€åŠŸç‡
  451   2      
  452   2              bluetooth_ch9141_default_connect(salve_mac_password); //é…ç½®é»˜è®¤è¿æ¥å‚æ•°ï¼Œå³ä½¿ä¸‹æ¬¡ä¸
             -é…ç½®ä¹Ÿä¼šè‡ªåŠ¨è¿æ¥ä»æœº
  453   2              bluetooth_ch9141_connect(salve_mac_password);         //ç«‹å³è¿æ¥è®¾ç½®çš„ä»æœºåœ°å€
  454   2      
  455   2              //ç­‰å¾…è¿æ¥æˆåŠŸ
  456   2              while (MASTER_CONNECTED != bluetooth_ch9141_get_status(mode))
  457   2                  ;
  458   2              bluetooth_ch9141_exit_at_mode(); //é€€å‡ºATæ¨¡å¼
  459   2          }
  460   1          else if (SLAVE_MODE == mode)
  461   1          {
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/06/24  16:35:49  PAGE 9   

  462   2              // 2.è“ç‰™è®¾ç½®ä¸ºä»æœºå¹¶ç­‰å¾…è¿æ¥
  463   2              bluetooth_ch9141_enter_at_mode();   //è¿›å…¥ATæ¨¡å¼
  464   2              bluetooth_ch9141_set_mode(mode);    //è®¾ç½®è“ç‰™æ¨¡å¼
  465   2              bluetooth_ch9141_get_mac_address(); //è·å–æœ¬æœºMACåœ°å€
  466   2              bluetooth_ch9141_reset();           //è®¾ç½®å®Œæˆåéœ€è¦å¤ä½ï¼Œè®¾ç½®æ‰ä¼šç”Ÿæ•ˆ
  467   2              bluetooth_ch9141_enter_at_mode();   //è¿›å…¥ATæ¨¡å¼
  468   2      
  469   2              //è®¾ç½®å®Œæ¨¡å¼ä¹‹åéœ€è¦å¤ä½ç„¶åå†æ¬¡è¿›å…¥ATæ¨¡å¼æ‰èƒ½ç»§ç»­è®¾ç½®å…¶ä»–å‚æ•°ï¼Œå¦
             -åˆ™æ¨¡å¼è®¾ç½®ä¸æˆåŠŸ
  470   2              bluetooth_ch9141_set_tx_power(TX_POWER_4DB); //è®¾ç½®è“ç‰™å‘é€åŠŸç‡
  471   2              bluetooth_ch9141_set_name("ble");
  472   2              bluetooth_ch9141_set_password(1, "000000"); // 000000ä¸ºè“ç‰™å¯†ç å¯ä»¥è‡ªå·±ä¿®æ”¹
  473   2              bluetooth_ch9141_reset();                   //è®¾ç½®å®Œæˆåéœ€è¦å¤ä½ï¼Œè®¾ç½®æ‰ä¼šç”Ÿæ•ˆ
  474   2              bluetooth_ch9141_enter_at_mode();           //è¿›å…¥ATæ¨¡å¼
  475   2              //ç­‰å¾…è¿æ¥æˆåŠŸ
  476   2              while (SLAVE_CONNECTED != bluetooth_ch9141_get_status(mode))
  477   2                  ;
  478   2              bluetooth_ch9141_exit_at_mode(); //é€€å‡ºATæ¨¡å¼
  479   2          }
  480   1      
  481   1          //å¦‚æœæƒ³è·å–æ— çº¿ä¿¡å·å¼ºåº¦å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„ç¤ºä¾‹è°ƒç”¨
  482   1          // bluetooth_ch9141_enter_at_mode();
  483   1          // int16 rssi = bluetooth_ch9141_get_rssi();
  484   1      
  485   1          DisableGlobalIRQ();
  486   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       914     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        53         15
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       135     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
