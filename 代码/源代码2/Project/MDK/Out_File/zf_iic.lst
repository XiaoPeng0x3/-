C251 COMPILER V5.60.0,  zf_iic                                                             14/06/24  16:35:47  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_iic
OBJECT MODULE PLACED IN .\Out_File\zf_iic.obj
COMPILER INVOKED BY: D:\Keil_v5\C251\BIN\C251.EXE ..\..\Libraries\seekfree_libraries\zf_iic.c XSMALL INTR2 WARNINGLEVEL(
                    -0) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\COD
                    -E;..\USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\zf_iic.lst) TABS(2) OBJECT(.\Out_File\zf_iic.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2020,é€é£ç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897(å·²æ»¡)  ä¸‰ç¾¤ï¼š824575535
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
    9           *
   10           * @file          iic
   11           * @company       æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author        é€é£ç§‘æŠ€(QQ790875685)
   13           * @version       æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   14           * @Software    MDK FOR C251 V5.60
   15           * @Target core   STC16F2K64S4
   16           * @Taobao      https://seekfree.taobao.com/
   17           * @date          2020-4-14
   18           ********************************************************************************************************
             -************/
   19          #pragma warning disable = 47
   20          #include "zf_iic.h"
   21          
   22          //-------------------------------------------------------------------------------------------------------
             -------------
   23          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   24          //  @param      NULL
   25          //  @return     void
   26          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   27          //-------------------------------------------------------------------------------------------------------
             -------------
   28          void iic_delay_us(uint16 x) // 33.1776Mhz
   29          {
   30   1          uint8 i;
   31   1          while (x--)
   32   1          {
   33   2              i = 9;
   34   2              while (--i)
   35   2                  ;
   36   2          }
   37   1      }
   38          
   39          //-------------------------------------------------------------------------------------------------------
             -------------
   40          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   41          //  @param      NULL
   42          //  @return     void
   43          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   44          //-------------------------------------------------------------------------------------------------------
             -------------
   45          uint8 wait(void)
   46          {
   47   1          uint16 count = 0;
   48   1          uint8 ret = IIC_SEND_OK;
   49   1          while (!(I2CMSST & 0x40))
   50   1          {
   51   2              iic_delay_us(1);
C251 COMPILER V5.60.0,  zf_iic                                                             14/06/24  16:35:47  PAGE 2   

   52   2              if (count++ >= 30) //ç­‰å¾…è¶…è¿‡30usï¼Œåˆ™é€€å‡ºç­‰å¾…ã€‚
   53   2              {
   54   3                  ret = IIC_SEND_FAIL;
   55   3                  break;
   56   3              }
   57   2          }
   58   1          I2CMSST &= ~0x40;
   59   1          return ret;
   60   1      }
   61          
   62          //-------------------------------------------------------------------------------------------------------
             -------------
   63          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   64          //  @param      NULL
   65          //  @return     void
   66          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   67          //-------------------------------------------------------------------------------------------------------
             -------------
   68          uint8 start(void)
   69          {
   70   1          uint8 ret;
   71   1          I2CMSCR = 0x01; //å‘é€startå‘½ä»¤
   72   1          ret = wait();
   73   1          return ret;
   74   1      }
   75          
   76          //-------------------------------------------------------------------------------------------------------
             -------------
   77          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   78          //  @param      NULL
   79          //  @return     void
   80          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   81          //-------------------------------------------------------------------------------------------------------
             -------------
   82          uint8 send_data(char dat)
   83          {
   84   1          uint8 ret;
   85   1          I2CTXD = dat;   //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
   86   1          I2CMSCR = 0x02; //å‘é€SENDå‘½ä»¤
   87   1          ret = wait();
   88   1          return ret;
   89   1      }
   90          
   91          //-------------------------------------------------------------------------------------------------------
             -------------
   92          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   93          //  @param      NULL
   94          //  @return     void
   95          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   96          //-------------------------------------------------------------------------------------------------------
             -------------
   97          uint8 recv_ack(void)
   98          {
   99   1          uint8 ret;
  100   1          I2CMSCR = 0x03; //å‘é€è¯»ACKå‘½ä»¤
  101   1          ret = wait();
  102   1          return ret;
  103   1      }
  104          
  105          //-------------------------------------------------------------------------------------------------------
             -------------
  106          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  107          //  @param      NULL
  108          //  @return     void
  109          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  110          //-------------------------------------------------------------------------------------------------------
C251 COMPILER V5.60.0,  zf_iic                                                             14/06/24  16:35:47  PAGE 3   

             -------------
  111          char recv_data(void) //æ¥æ”¶æ•°æ®
  112          {
  113   1          I2CMSCR = 0x04; //å‘é€RECVå‘½ä»¤
  114   1          wait();
  115   1          return I2CRXD;
  116   1      }
  117          
  118          //-------------------------------------------------------------------------------------------------------
             -------------
  119          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  120          //  @param      NULL
  121          //  @return     void
  122          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  123          //-------------------------------------------------------------------------------------------------------
             -------------
  124          uint8 send_ack(void)
  125          {
  126   1          uint8 ret;
  127   1          I2CMSST = 0x00; //è®¾ç½®ACKä¿¡å·
  128   1          I2CMSCR = 0x05; //å‘é€ACKå‘½ä»¤
  129   1          ret = wait();
  130   1          return ret;
  131   1      }
  132          
  133          //-------------------------------------------------------------------------------------------------------
             -------------
  134          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  135          //  @param      NULL
  136          //  @return     void
  137          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  138          //-------------------------------------------------------------------------------------------------------
             -------------
  139          void send_nak(void)
  140          {
  141   1          I2CMSST = 0x01; //è®¾ç½®NAKä¿¡å·
  142   1          I2CMSCR = 0x05; //å‘é€ACKå‘½ä»¤
  143   1          wait();
  144   1      }
  145          
  146          //-------------------------------------------------------------------------------------------------------
             -------------
  147          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  148          //  @param      NULL
  149          //  @return     void
  150          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  151          //-------------------------------------------------------------------------------------------------------
             -------------
  152          uint8 stop(void)
  153          {
  154   1          uint8 ret;
  155   1          I2CMSCR = 0x06; //å‘é€stopå‘½ä»¤
  156   1          ret = wait();
  157   1          return ret;
  158   1      }
  159          
  160          //#define UNUSED(expr1, expr2) do { if(scl_pin == sda_pin); } while (0)
  161          //-------------------------------------------------------------------------------------------------------
             -------------
  162          //  @brief      ç¡¬ä»¶IICåˆå§‹åŒ–
  163          //  @param      iic_n           é€‰æ‹©IICæ¨¡å—
  164          //  @param      wait_time       I2Cæ€»çº¿é€Ÿåº¦ï¼ˆç­‰å¾…æ—¶é’Ÿæ•°ï¼‰æ§åˆ¶: é€Ÿåº¦è®¾ç½®ä¸ºç­‰å¾…wait_tim
             -e*2+1ä¸ªæ—¶é’Ÿ
  165          //  @return     void
  166          //  Sample usage:
  167          //-------------------------------------------------------------------------------------------------------
C251 COMPILER V5.60.0,  zf_iic                                                             14/06/24  16:35:47  PAGE 4   

             -------------
  168          void iic_init(IICN_enum iic_n, IIC_PIN_enum scl_pin, IIC_PIN_enum sda_pin, uint32 wait_time)
  169          {
  170   1          // UNUSED(scl_pin);
  171   1          //__attribute__ ((unused))(sda_pin);
  172   1          // UNUSED(scl_pin, sda_pin);
  173   1      
  174   1          P_SW2 &= ~(0x03 << 4);
  175   1          P_SW2 |= 1 << 7; //å°†EAXFRå¯„å­˜å™¨ç½®1ï¼Œè¿™æ ·æ‰èƒ½ä½¿ç”¨ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨ä¸ºæ‰©å±•SFRï¼Œè®¿é
             -—®é€»è¾‘åœ°å€ä½äº XDATA åŒºåŸŸ
  176   1          switch (iic_n)
  177   1          {
  178   2          case IIC_1:
  179   2              P_SW2 |= (0x00 << 4); // SCL:P1.5 SDA:P1.4
  180   2              break;
  181   2          case IIC_2:
  182   2              P_SW2 |= (0x01 << 4); // SCL:P2.5 SDA:P2.4
  183   2              break;
  184   2          case IIC_3:
  185   2              P_SW2 |= (0x02 << 4); // SCL:P7.7 SDA:P7.6
  186   2              break;
  187   2          case IIC_4:
  188   2              P_SW2 |= (0x03 << 4); // SCL:P3.2 SDA:P3.3
  189   2              break;
  190   2          }
  191   1      
  192   1          I2CCFG |= 1 << 6;    //ä¸»æœºæ¨¡å¼
  193   1          I2CCFG |= 1 << 7;    //ä½¿èƒ½IIC
  194   1          I2CCFG |= wait_time; //é€Ÿåº¦è®¾ç½®ä¸ºç­‰å¾…wait_time*2+1ä¸ªæ—¶é’Ÿ
  195   1          I2CMSST = 0x00;      //ä¸»æœºçŠ¶æ€å¯„å­˜å™¨
  196   1      }
  197          
  198          //-------------------------------------------------------------------------------------------------------
             -------------
  199          //  @brief      å†™å…¥ä¸€ä¸ªå­—èŠ‚æ•°æ®åˆ°I2Cè®¾å¤‡æŒ‡å®šå¯„å­˜å™¨åœ°å€
  200          //  @param      iic_n       IICæ¨¡å—(IIC_1,IIC_2,IIC_3,IIC_0)
  201          //  @param      slaveid     ä»æœºåœ°å€(7ä½åœ°å€)
  202          //  @param      reg         ä»æœºå¯„å­˜å™¨åœ°å€
  203          //  @param      dat         éœ€è¦å‘é€çš„æ•°æ®
  204          //  @return                 è¿”å›çš„çŠ¶æ€å€¼ 0ï¼šæˆåŠŸ  1ï¼šå¤±è´¥
  205          //  @since      v2.0
  206          //  Sample usage:         iic_write_reg(0x2D, 0x50,2);     //å†™å…¥æ•°æ®2åˆ°0x50åœ°å€ï¼Œä»æœºåœ°å€ä¸º0
             -x2D
  207          //-------------------------------------------------------------------------------------------------------
             -------------
  208          uint8 iic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
  209          {
  210   1          if (start() != IIC_SEND_OK)
  211   1              return IIC_SEND_FAIL;
  212   1          if (send_data((dev_add << 1) | 0x00) != IIC_SEND_OK)
  213   1              return IIC_SEND_FAIL;
  214   1          if (recv_ack() != IIC_SEND_OK)
  215   1              return IIC_SEND_FAIL;
  216   1          if (send_data(reg) != IIC_SEND_OK)
  217   1              return IIC_SEND_FAIL;
  218   1          if (recv_ack() != IIC_SEND_OK)
  219   1              return IIC_SEND_FAIL;
  220   1          if (send_data(dat) != IIC_SEND_OK)
  221   1              return IIC_SEND_FAIL;
  222   1          if (recv_ack() != IIC_SEND_OK)
  223   1              return IIC_SEND_FAIL;
  224   1          if (stop() != IIC_SEND_OK)
  225   1              return IIC_SEND_FAIL;
  226   1      
  227   1          return IIC_SEND_OK;
  228   1      }
C251 COMPILER V5.60.0,  zf_iic                                                             14/06/24  16:35:47  PAGE 5   

  229          
  230          //-------------------------------------------------------------------------------------------------------
             -------------
  231          //  @brief      è¯»å–I2Cè®¾å¤‡æŒ‡å®šåœ°å€å¯„å­˜å™¨çš„æ•°æ®
  232          //  @param      iic_n        I2Cé€šé“å·åŠå¼•è„š
  233          //  @param      dev_add     ä»æœºåœ°å€(7ä½åœ°å€)
  234          //  @param      reg         ä»æœºå¯„å­˜å™¨åœ°å€
  235          //  @param      dat         æ•°æ®åœ°å€
  236          //  @return                 è¯»å–çš„å¯„å­˜å™¨å€¼
  237          //  @since      v1.0
  238          //  Sample usage:         uint8 value = iic_read_reg(i2c0, 0x2D, 0x50);//è¯»å–0x50åœ°å€çš„æ•°æ®ï¼Œä»æœ
             -ºåœ°å€ä¸º0x2D
  239          //-------------------------------------------------------------------------------------------------------
             -------------
  240          uint8 iic_read_reg(uint8 dev_add, uint8 reg, uint8 *dat)
  241          {
  242   1          if (start() != IIC_SEND_OK)
  243   1              return IIC_SEND_FAIL;
  244   1      
  245   1          if (send_data((dev_add << 1) | 0x00) != IIC_SEND_OK)
  246   1              return IIC_SEND_FAIL;
  247   1          if (recv_ack() != IIC_SEND_OK)
  248   1              return IIC_SEND_FAIL;
  249   1      
  250   1          if (send_data(reg) != IIC_SEND_OK)
  251   1              return IIC_SEND_FAIL;
  252   1          if (recv_ack() != IIC_SEND_OK)
  253   1              return IIC_SEND_FAIL;
  254   1      
  255   1          //   if(start() != IIC_SEND_OK)
  256   1          //        return IIC_SEND_FAIL;
  257   1      
  258   1          if (send_data((dev_add << 1) | 0x01) != IIC_SEND_OK)
  259   1              return IIC_SEND_FAIL;
  260   1      
  261   1          if (recv_ack() != IIC_SEND_OK)
  262   1              return IIC_SEND_FAIL;
  263   1      
  264   1          *dat = recv_data(); //è¯»å–æ•°æ®
  265   1      
  266   1          if (send_ack() != IIC_SEND_OK)
  267   1              return IIC_SEND_FAIL;
  268   1      
  269   1          if (stop() != IIC_SEND_OK)
  270   1              return IIC_SEND_FAIL;
  271   1      
  272   1          return IIC_SEND_OK;
  273   1      }
  274          
  275          //-------------------------------------------------------------------------------------------------------
             -------------
  276          //  @brief      è¯»å–I2Cè®¾å¤‡æŒ‡å®šåœ°å€å¯„å­˜å™¨çš„æ•°æ®
  277          //  @param      iic_n       I2Cé€šé“å·åŠå¼•è„š
  278          //  @param      dev_add     ä»æœºåœ°å€(7ä½åœ°å€)
  279          //  @param      reg         ä»æœºå¯„å­˜å™¨åœ°å€
  280          //  @param      dat         è¯»å–çš„æ•°æ®å­˜å‚¨çš„åœ°å€
  281          //  @param      num         è¯»å–å­—èŠ‚æ•°
  282          //  @return     void
  283          //  @since      v1.0
  284          //  Sample usage:         uint8 value = i2c_read_reg(i2c0, 0x2D, 0x50, 10, buf);//è¯»å–0x50åœ°å€çš„æ•°æ
             -®ï¼Œä»æœºåœ°å€ä¸º0x2Då¼€å§‹çš„10ä¸ªå­—èŠ‚
  285          //-------------------------------------------------------------------------------------------------------
             -------------
  286          uint8 iic_read_reg_bytes(uint8 dev_add, uint8 reg, uint8 *dat, uint8 num)
  287          {
  288   1      
C251 COMPILER V5.60.0,  zf_iic                                                             14/06/24  16:35:47  PAGE 6   

  289   1          if (start() != IIC_SEND_OK)
  290   1              return IIC_SEND_FAIL;
  291   1      
  292   1          if (send_data((dev_add << 1) | 0x00) != IIC_SEND_OK)
  293   1              return IIC_SEND_FAIL;
  294   1          if (recv_ack() != IIC_SEND_OK)
  295   1              return IIC_SEND_FAIL;
  296   1      
  297   1          if (send_data(reg) != IIC_SEND_OK)
  298   1              return IIC_SEND_FAIL;
  299   1          if (recv_ack() != IIC_SEND_OK)
  300   1              return IIC_SEND_FAIL;
  301   1      
  302   1          if (send_data((dev_add << 1) | 0x01) != IIC_SEND_OK)
  303   1              return IIC_SEND_FAIL;
  304   1          if (recv_ack() != IIC_SEND_OK)
  305   1              return IIC_SEND_FAIL;
  306   1      
  307   1          while (--num)
  308   1          {
  309   2              *dat = recv_data(); //è¯»å–æ•°æ®
  310   2              if (send_ack() != IIC_SEND_OK)
  311   2              {
  312   3                  return IIC_SEND_FAIL;
  313   3              }
  314   2              dat++;
  315   2          }
  316   1      
  317   1          *dat = recv_data();
  318   1      
  319   1          if (send_ack() != IIC_SEND_OK)
  320   1              return IIC_SEND_FAIL;
  321   1      
  322   1          if (stop() != IIC_SEND_OK)
  323   1              return IIC_SEND_FAIL;
  324   1      
  325   1          return IIC_SEND_OK;
  326   1      }
  327          
  328          //-------------------------------------------------------------------------------------------------------
             -------------
  329          //  @brief      ç¡¬ä»¶IICå¼•è„šåˆ‡æ¢å‡½æ•°
  330          //  @param      iic_n         I2Cé€šé“å·åŠå¼•è„š
  331          //  @param      scl_pin         é€‰æ‹©SCLå¼•è„š
  332          //  @param      sda_pin         é€‰æ‹©SDAå¼•è„š
  333          //  Sample usage:
  334          //-------------------------------------------------------------------------------------------------------
             -------------
  335          void iic_change_pin(IICN_enum iic_n, IIC_PIN_enum scl_pin, IIC_PIN_enum sda_pin)
  336          {
  337   1          P_SW2 |= 1 << 7; //å°†EAXFRå¯„å­˜å™¨ç½®1ï¼Œè¿™æ ·æ‰èƒ½ä½¿ç”¨ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨ä¸ºæ‰©å±•SFRï¼Œè®¿é
             -—®é€»è¾‘åœ°å€ä½äº XDATA åŒºåŸŸ
  338   1      
  339   1          P_SW2 &= ~(0x03 << 4); //æ¸…é™¤å¼•è„šåˆ‡æ¢ä½
  340   1          switch (iic_n)
  341   1          {
  342   2          case IIC_1:
  343   2              P_SW2 |= (0x00 << 4); // SCL:P1.5 SDA:P1.4
  344   2              break;
  345   2          case IIC_2:
  346   2              P_SW2 |= (0x01 << 4); // SCL:P2.5 SDA:P2.4
  347   2              break;
  348   2          case IIC_3:
  349   2              P_SW2 |= (0x02 << 4); // SCL:P7.7 SDA:P7.6 STC8H 48è„šæ ¸å¿ƒæ¿æ²¡æœ‰è¯¥ç»„å¼•è„šã€‚
  350   2              break;
  351   2          case IIC_4:
C251 COMPILER V5.60.0,  zf_iic                                                             14/06/24  16:35:47  PAGE 7   

  352   2              P_SW2 |= (0x03 << 4); // SCL:P3.2 SDA:P3.3
  353   2              break;
  354   2          }
  355   1      
  356   1          P_SW2 &= ~(1 << 7);
  357   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       748     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------         11
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
