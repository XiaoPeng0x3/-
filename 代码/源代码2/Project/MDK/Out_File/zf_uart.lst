C251 COMPILER V5.60.0,  zf_uart                                                            14/06/24  16:35:48  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_uart
OBJECT MODULE PLACED IN .\Out_File\zf_uart.obj
COMPILER INVOKED BY: D:\Keil_v5\C251\BIN\C251.EXE ..\..\Libraries\seekfree_libraries\zf_uart.c XSMALL INTR2 WARNINGLEVEL
                    -(0) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CO
                    -DE;..\USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\zf_uart.lst) TABS(2) OBJECT(.\Out_File\zf_uart.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2020,é€é£žç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897(å·²æ»¡)  ä¸‰ç¾¤ï¼š824575535
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±žé€é£žç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºŽå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿Žå„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£žç§‘æŠ€çš„ç‰ˆæƒå£°æ˜Žã€‚
    9           *
   10           * @file          uart
   11           * @company       æˆéƒ½é€é£žç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author        é€é£žç§‘æŠ€(QQ790875685)
   13           * @version       æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜Ž
   14           * @Software    MDK FOR C251 V5.60
   15           * @Target core   STC16F40K128
   16           * @Taobao      https://seekfree.taobao.com/
   17           * @date          2020-4-14
   18           ********************************************************************************************************
             -************/
   19          
   20          #include "zf_uart.h"
   21          #include "board.h"
   22          
   23          uint8 busy[5]; //æŽ¥æ”¶å¿™æ ‡å¿—ä½
   24          
   25          uint8 uart1_tx_buff[UART1_TX_BUFFER_SIZE]; //å‘é€ç¼“å†²
   26          uint8 uart1_rx_buff[UART1_RX_BUFFER_SIZE]; //æŽ¥æ”¶ç¼“å†²
   27          
   28          //-------------------------------------------------------------------------------------------------------
             -------------
   29          //  @brief      ä¸²å£åˆå§‹åŒ–
   30          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
   31          //  @param      uart_rx_pin     ä¸²å£æ³¢ç‰¹çŽ‡
   32          //  @param      uart_tx_pin     ä¸²å£æŽ¥æ”¶å‘é€å¼•è„š
   33          //  @param      baud          ä¸²å£æŽ¥æ”¶å‘é€å¼•è„š
   34          //  @param      tim_n         ä½¿ç”¨tim_nä½œä¸ºä¸²å£æ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨(TIM1-TIM4)
   35          //  @return     NULL
   36          //  Sample usage:               uart_init(UART_1, UART1_RX_P30, UART1_TX_P31, 115200, TIM_2);        //åˆ
             -å§‹åŒ–ä¸²å£1 æ³¢ç‰¹çŽ‡115200 å‘é€å¼•è„šä½¿ç”¨P31 æŽ¥æ”¶å¼•è„šä½¿ç”¨P30 ,ä½¿ç”¨å®šæ—¶å™¨2ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨
   37          //  @note                       ä¸²å£1ä½¿ç”¨ å®šæ—¶å™¨1æˆ–è€…å®šæ—¶å™¨2 ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   38          //                ä¸²å£2ä½¿ç”¨ å®šæ—¶å™¨2       ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   39          //                ä¸²å£3ä½¿ç”¨ å®šæ—¶å™¨3æˆ–è€…å®šæ—¶å™¨2 ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   40          //                ä¸²å£4ä½¿ç”¨ å®šæ—¶å™¨4æˆ–è€…å®šæ—¶å™¨2 ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   41          //                              STC8Hä»…æœ‰ å®šæ—¶å™¨0-å®šæ—¶å™¨4ï¼Œè¿™5ä¸ªå®šæ—¶å™¨ã€‚
   42          //                ç¼–ç å™¨é‡‡é›†æ•°æ®ä¹Ÿéœ€è¦å®šæ—¶å™¨ä½œä¸ºå¤–éƒ¨è®¡æ•°ã€‚
   43          //                å¦‚æžœä¸åŒçš„ä¸²å£ï¼Œä½¿ç”¨åŒä¸€ä¸ªå®šæ—¶å™¨ï¼Œä¸²å£çš„æ³¢ç‰¹çŽ‡ä»¥æœ€åŽä¸€ä¸ªåˆå§‹åŒ–ä¸
             -ºå‡†
   44          //-------------------------------------------------------------------------------------------------------
             -------------
   45          void uart_init(UARTN_enum uart_n, UARTPIN_enum uart_rx_pin, UARTPIN_enum uart_tx_pin, uint32 baud, TIMN_e
             -num tim_n)
   46          {
   47   1        uint16 brt;
   48   1      
   49   1        brt = (uint16)(65536 - (sys_clk / baud / 4));
   50   1      
C251 COMPILER V5.60.0,  zf_uart                                                            14/06/24  16:35:48  PAGE 2   

   51   1        switch (uart_n)
   52   1        {
   53   2        case UART_1:
   54   2        {
   55   3          if (TIM_1 == tim_n)
   56   3          {
   57   4            SCON |= 0x50;
   58   4            TMOD |= 0x00;
   59   4            TL1 = brt;
   60   4            TH1 = brt >> 8;
   61   4            AUXR |= 0x40;
   62   4            TR1 = 1;
   63   4            busy[1] = 0;
   64   4          }
   65   3          else if (TIM_2 == tim_n)
   66   3          {
   67   4            SCON |= 0x50;
   68   4            T2L = brt;
   69   4            T2H = brt >> 8;
   70   4            AUXR |= 0x15;
   71   4          }
   72   3          P_SW1 &= ~(0x03 << 6);
   73   3          if ((UART1_RX_P30 == uart_rx_pin) && (UART1_TX_P31 == uart_tx_pin))
   74   3          {
   75   4            P_SW1 |= 0x00;
   76   4          }
   77   3          else if ((UART1_RX_P36 == uart_rx_pin) && (UART1_TX_P37 == uart_tx_pin))
   78   3          {
   79   4            P_SW1 |= 0x40;
   80   4          }
   81   3          else if ((UART1_RX_P16 == uart_rx_pin) && (UART1_TX_P17 == uart_tx_pin))
   82   3          {
   83   4            P_SW1 |= 0x80;
   84   4          }
   85   3          else if ((UART1_RX_P43 == uart_rx_pin) && (UART1_TX_P44 == uart_tx_pin))
   86   3          {
   87   4            P_SW1 |= 0xc0;
   88   4          }
   89   3          busy[1] = 0;
   90   3          ES = 1;
   91   3          break;
   92   3        }
   93   2      
   94   2        case UART_2:
   95   2        {
   96   3          if (TIM_2 == tim_n)
   97   3          {
   98   4            S2CON |= 0x10;
   99   4            T2L = brt;
  100   4            T2H = brt >> 8;
  101   4            AUXR |= 0x14;
  102   4          }
  103   3      
  104   3          P_SW2 &= ~(0x01 << 0);
  105   3          if ((UART2_RX_P10 == uart_rx_pin) && (UART2_TX_P11 == uart_tx_pin))
  106   3          {
  107   4            P_SW2 |= 0x00;
  108   4          }
  109   3          else if ((UART2_RX_P46 == uart_rx_pin) && (UART2_TX_P47 == uart_tx_pin))
  110   3          {
  111   4            P_SW2 |= 0x01;
  112   4          }
  113   3      
  114   3          IE2 |= 0x01 << 0; //å…è®¸ä¸²è¡Œå£2ä¸­æ–­
  115   3          busy[2] = 0;
  116   3          break;
C251 COMPILER V5.60.0,  zf_uart                                                            14/06/24  16:35:48  PAGE 3   

  117   3        }
  118   2      
  119   2        case UART_3:
  120   2        {
  121   3          if (TIM_2 == tim_n)
  122   3          {
  123   4            S3CON |= 0x10;
  124   4            T2L = brt;
  125   4            T2H = brt >> 8;
  126   4            AUXR |= 0x14;
  127   4          }
  128   3          else if (TIM_3 == tim_n)
  129   3          {
  130   4            S3CON |= 0x50;
  131   4            T3L = brt;
  132   4            T3H = brt >> 8;
  133   4            T4T3M |= 0x0a;
  134   4          }
  135   3      
  136   3          P_SW2 &= ~(0x01 << 1);
  137   3          if ((UART3_RX_P00 == uart_rx_pin) && (UART3_TX_P01 == uart_tx_pin))
  138   3          {
  139   4            P_SW2 |= 0x00;
  140   4          }
  141   3          else if ((UART3_RX_P50 == uart_rx_pin) && (UART3_TX_P51 == uart_tx_pin))
  142   3          {
  143   4            P_SW2 |= 0x02;
  144   4          }
  145   3      
  146   3          IE2 |= 0x01 << 3; //å…è®¸ä¸²è¡Œå£3ä¸­æ–­
  147   3          busy[3] = 0;
  148   3          break;
  149   3        }
  150   2      
  151   2        case UART_4:
  152   2        {
  153   3          if (TIM_2 == tim_n)
  154   3          {
  155   4            S4CON |= 0x10;
  156   4            T2L = brt;
  157   4            T2H = brt >> 8;
  158   4            AUXR |= 0x14;
  159   4          }
  160   3          else if (TIM_4 == tim_n)
  161   3          {
  162   4            S4CON |= 0x50;
  163   4            T4L = brt;
  164   4            T4H = brt >> 8;
  165   4            T4T3M |= 0xa0;
  166   4          }
  167   3      
  168   3          P_SW2 &= ~(0x01 << 2);
  169   3          if ((UART4_RX_P02 == uart_rx_pin) && (UART4_TX_P03 == uart_tx_pin))
  170   3          {
  171   4            P_SW2 |= 0x00;
  172   4          }
  173   3          else if ((UART4_RX_P52 == uart_rx_pin) && (UART4_TX_P53 == uart_tx_pin))
  174   3          {
  175   4            P5M0 = 0x00;
  176   4            P5M1 = 0x01 << 2; // P5.2 éœ€è¦è®¾ç½®ä¸ºé«˜é˜»
  177   4            P_SW2 |= 0x04;
  178   4          }
  179   3          IE2 |= 0x01 << 4; //å…è®¸ä¸²è¡Œå£4ä¸­æ–­
  180   3          busy[4] = 0;
  181   3          break;
  182   3        }
C251 COMPILER V5.60.0,  zf_uart                                                            14/06/24  16:35:48  PAGE 4   

  183   2        }
  184   1      }
  185          
  186          //-------------------------------------------------------------------------------------------------------
             -------------
  187          //  @brief      ä¸²å£å­—èŠ‚è¾“å‡º
  188          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
  189          //  @param      dat             éœ€è¦å‘é€çš„å­—èŠ‚
  190          //  @return     void
  191          //  Sample usage:               uart_putchar(UART_1,0xA5);       // ä¸²å£1å‘é€0xA5
  192          //-------------------------------------------------------------------------------------------------------
             -------------
  193          void uart_putchar(UARTN_enum uart_n, uint8 dat)
  194          {
  195   1        switch (uart_n)
  196   1        {
  197   2        case UART_1:
  198   2          while (busy[1])
  199   2            ;
  200   2          busy[1] = 1;
  201   2          SBUF = dat;
  202   2          break;
  203   2        case UART_2:
  204   2          while (busy[2])
  205   2            ;
  206   2          busy[2] = 1;
  207   2          S2BUF = dat;
  208   2          break;
  209   2        case UART_3:
  210   2          while (busy[3])
  211   2            ;
  212   2          busy[3] = 1;
  213   2          S3BUF = dat;
  214   2          break;
  215   2        case UART_4:
  216   2          while (busy[4])
  217   2            ;
  218   2          busy[4] = 1;
  219   2          S4BUF = dat;
  220   2          break;
  221   2        }
  222   1      }
  223          
  224          //-------------------------------------------------------------------------------------------------------
             -------------
  225          //  @brief      ä¸²å£å‘é€æ•°ç»„
  226          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
  227          //  @param      *buff           è¦å‘é€çš„æ•°ç»„åœ°å€
  228          //  @param      len             å‘é€é•¿åº¦
  229          //  @return     void
  230          //  Sample usage:               uart_putbuff(UART_1,&a[0],5);
  231          //-------------------------------------------------------------------------------------------------------
             -------------
  232          void uart_putbuff(UARTN_enum uart_n, uint8 *p, uint16 len)
  233          {
  234   1        while (len--)
  235   1          uart_putchar(uart_n, *p++);
  236   1      }
  237          
  238          //-------------------------------------------------------------------------------------------------------
             -------------
  239          //  @brief      ä¸²å£å‘é€å­—ç¬¦ä¸²
  240          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
  241          //  @param      *str            è¦å‘é€çš„å­—ç¬¦ä¸²åœ°å€
  242          //  @return     void
  243          //  Sample usage:               uart_putstr(UART_1,"i lvoe you");
C251 COMPILER V5.60.0,  zf_uart                                                            14/06/24  16:35:48  PAGE 5   

  244          //-------------------------------------------------------------------------------------------------------
             -------------
  245          void uart_putstr(UARTN_enum uart_n, uint8 *str)
  246          {
  247   1        while (*str)
  248   1        {
  249   2          uart_putchar(uart_n, *str++);
  250   2        }
  251   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       606     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       205         12
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
